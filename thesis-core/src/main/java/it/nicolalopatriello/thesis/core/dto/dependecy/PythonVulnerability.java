package it.nicolalopatriello.thesis.core.dto.dependecy;

import com.vdurmont.semver4j.Semver;
import it.nicolalopatriello.thesis.common.Jsonizable;
import it.nicolalopatriello.thesis.core.dto.VersionOperator;
import lombok.Getter;
import lombok.Setter;
import lombok.extern.log4j.Log4j;
import org.apache.maven.artifact.versioning.ComparableVersion;

import java.io.File;
import java.util.HashMap;
import java.util.List;
import java.util.Optional;

@Log4j
@Getter
@Setter
public class PythonVulnerability extends HashMap<String, List<PythonVulnerability.Item>> {

    @Getter
    @Setter
    public static class Item {
        private String advisory;
        private String cve;
        private String id;
        private List<String> specs;
        private String v;

        public boolean match(String version) {
            boolean match = false;
            for (String spec : specs) {
                Semver version1_1_alpha = new Semver("1.1.0-alpha");
                log.info("Item version to check: " + spec + " - Input version: " + version);
                if (!match) {
                    Optional<String> s = VersionOperator.extract(spec);
                    if (s.isPresent())
                        match = check(s.get(), version)
                }
            }
            return match;
        }

        private boolean check(String operator, String version) {
            return false;
        }
    }

    public static Optional<PythonVulnerability> from(File f) {
        try {
            HashMap<?, ?> obj = Jsonizable.fromFile(f, HashMap.class);
            obj.remove("$meta");
            Optional<PythonVulnerability> t = Optional.ofNullable(Jsonizable.fromJson(Jsonizable.toJson(obj), PythonVulnerability.class));
            return t;
        } catch (Exception e) {
            log.error(e.getMessage(), e);
        }
        return Optional.empty();
    }
}
